name: Generate Game Content

on:
  workflow_dispatch:
    inputs:
      content_type:
        description: 'Type of content to generate'
        required: true
        type: choice
        options:
          - dialogue
          - quest
          - background
          - all
      prompt:
        description: 'Generation prompt (optional, uses defaults if empty)'
        required: false
        type: string

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

jobs:
  generate-dialogue:
    if: inputs.content_type == 'dialogue' || inputs.content_type == 'all'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --filter content-gen

      - name: Generate dialogue with Gemini
        run: |
          node << 'EOF'
          const { GoogleGenerativeAI } = require('@google/generative-ai');
          const fs = require('fs');
          const path = require('path');

          const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
          const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-exp' });

          const prompt = process.env.CUSTOM_PROMPT || `
          Generate a new dialogue sequence for Neo-Tokyo: Rival Academies.

          Context:
          - Kai Takeda: Hot-blooded racer, emotional, impulsive
          - Vera Vector: Cold, calculating, precise
          - Setting: Cyberpunk Neo-Tokyo, rooftop racing

          Requirements:
          - 4-6 dialogue nodes
          - JSON format matching existing structure
          - Shows character personality through word choice
          - Advances plot or develops relationship

          Return ONLY valid JSON in this format:
          {
            "dialogue_id": "unique_name",
            "nodes": [
              {"id": "node_1", "speaker": "Kai", "text": "...", "next": "node_2"},
              {"id": "node_2", "speaker": "Vera", "text": "...", "next": null}
            ]
          }
          `;

          async function generate() {
            console.log('Generating dialogue...');
            const result = await model.generateContent(prompt);
            const text = result.response.text();

            // Extract JSON from markdown code blocks if present
            const jsonMatch = text.match(/```json\n([\s\S]*?)\n```/) || text.match(/```\n([\s\S]*?)\n```/);
            const jsonText = jsonMatch ? jsonMatch[1] : text;

            const generated = JSON.parse(jsonText);

            // Merge with existing story.json
            const storyPath = path.join(process.cwd(), 'packages/game/src/data/story.json');
            const story = JSON.parse(fs.readFileSync(storyPath, 'utf8'));

            story.dialogues[generated.dialogue_id] = generated.nodes;

            fs.writeFileSync(storyPath, JSON.stringify(story, null, 2));
            console.log(`✅ Added dialogue: ${generated.dialogue_id}`);
          }

          generate().catch(console.error);
          EOF
        env:
          CUSTOM_PROMPT: ${{ inputs.prompt }}

      - name: Commit generated dialogue
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/game/src/data/story.json
          git diff --staged --quiet || git commit -m "feat: add AI-generated dialogue sequence"
          git push

  generate-quest:
    if: inputs.content_type == 'quest' || inputs.content_type == 'all'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --filter content-gen

      - name: Generate quest with Gemini
        run: |
          node << 'EOF'
          const { GoogleGenerativeAI } = require('@google/generative-ai');
          const fs = require('fs');
          const path = require('path');

          const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
          const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-exp' });

          const prompt = process.env.CUSTOM_PROMPT || `
          Generate a new side quest for Neo-Tokyo: Rival Academies JRPG.

          Context:
          - 3D platformer with RPG progression
          - Cyberpunk Neo-Tokyo setting
          - Player can access rooftops, alien ships, malls

          Requirements:
          - Quest ID, title, description
          - 3-5 objectives
          - Meaningful reward (weapon, accessory, or ability)
          - Ties into main narrative themes (rivalry, trust, conspiracy)

          Return ONLY valid JSON in this format:
          {
            "id": "unique_quest_id",
            "title": "Quest Title",
            "description": "What the quest is about",
            "objectives": ["Objective 1", "Objective 2", "Objective 3"],
            "reward": "Reward description",
            "giver": "NPC name",
            "location": "Where it starts"
          }
          `;

          async function generate() {
            console.log('Generating quest...');
            const result = await model.generateContent(prompt);
            const text = result.response.text();

            const jsonMatch = text.match(/```json\n([\s\S]*?)\n```/) || text.match(/```\n([\s\S]*?)\n```/);
            const jsonText = jsonMatch ? jsonMatch[1] : text;

            const generated = JSON.parse(jsonText);

            const storyPath = path.join(process.cwd(), 'packages/game/src/data/story.json');
            const story = JSON.parse(fs.readFileSync(storyPath, 'utf8'));

            story.quests.side_quests.push(generated);

            fs.writeFileSync(storyPath, JSON.stringify(story, null, 2));
            console.log(`✅ Added quest: ${generated.title}`);
          }

          generate().catch(console.error);
          EOF
        env:
          CUSTOM_PROMPT: ${{ inputs.prompt }}

      - name: Commit generated quest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/game/src/data/story.json
          git diff --staged --quiet || git commit -m "feat: add AI-generated side quest"
          git push

  generate-background:
    if: inputs.content_type == 'background' || inputs.content_type == 'all'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Google AI SDK
        run: pip install google-generativeai pillow

      - name: Generate background with Imagen
        run: |
          python << 'EOF'
          import google.generativeai as genai
          import os
          from pathlib import Path

          genai.configure(api_key=os.environ['GEMINI_API_KEY'])

          prompt = os.environ.get('CUSTOM_PROMPT') or """
          Cyberpunk Neo-Tokyo parallax background layer for a 3D platformer game.
          Style: Neon-lit skyscrapers, holographic billboards, flying vehicles.
          Composition: Horizontal panorama, depth layers for parallax scrolling.
          Color palette: Deep purples, electric blues, hot pinks, neon greens.
          Mood: Futuristic, energetic, slightly dystopian.
          No characters, focus on architecture and atmosphere.
          """

          # Note: Imagen 4 API example - adjust based on actual API
          try:
              model = genai.GenerativeModel('imagen-4')
              response = model.generate_images(
                  prompt=prompt,
                  number_of_images=3,  # Generate multiple layers
                  aspect_ratio='16:9'
              )

              output_dir = Path('packages/game/public/assets/backgrounds/generated')
              output_dir.mkdir(parents=True, exist_ok=True)

              for i, image in enumerate(response.images):
                  output_path = output_dir / f'layer_{i+1}.png'
                  image.save(output_path)
                  print(f'✅ Saved: {output_path}')

          except Exception as e:
              print(f'⚠️  Image generation not available yet: {e}')
              print('Creating placeholder for now...')
              # Create placeholder
              from PIL import Image
              img = Image.new('RGB', (1920, 1080), color=(20, 5, 40))
              output_dir = Path('packages/game/public/assets/backgrounds/generated')
              output_dir.mkdir(parents=True, exist_ok=True)
              img.save(output_dir / 'placeholder.png')
          EOF
        env:
          CUSTOM_PROMPT: ${{ inputs.prompt }}

      - name: Commit generated backgrounds
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/game/public/assets/backgrounds/
          git diff --staged --quiet || git commit -m "feat: add AI-generated background layers"
          git push
